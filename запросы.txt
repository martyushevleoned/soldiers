-- Таблицы -------------------------------------------------------------------------------------------------------------

CREATE TABLE "Подразделение" (
	"ID_командира_подразделения" integer NOT NULL,
	"ID_подразделения" integer NOT NULL,
	"Тип_подразделения" TEXT NOT NULL,
	"ID_большего_подразделения" integer NOT NULL,
	"Тип_большего_подразделения" TEXT NOT NULL,
	"ID_места_дислокации" integer NOT NULL,
	"Название_подразделения" TEXT NOT NULL,
	CONSTRAINT "Подразделение_pk" PRIMARY KEY ("ID_командира_подразделения","ID_подразделения")
) WITH (
  OIDS=FALSE
);



CREATE TABLE "Военнослужащий" (
	"ID_военнослужащего" integer NOT NULL,
	"ID_подразделения" integer NOT NULL,
	"ID_подчинённого_подразделения" integer,
	"ФИО_военнослужащего" TEXT NOT NULL,
	"Звание" TEXT NOT NULL,
	"Состав" TEXT NOT NULL,
	"Должность" TEXT,
	"Специальность" TEXT,
	"Выслуга_лет" integer NOT NULL,
	CONSTRAINT "Военнослужащий_pk" PRIMARY KEY ("ID_Военнослужащего")
) WITH (
  OIDS=FALSE
);
-- +ID_Подразделения



CREATE TABLE "Имущество" (
	"ID_подразделения" integer NOT NULL,
	"ID_имущества" integer NOT NULL,
	"Наименование" TEXT NOT NULL,
	"Тип_имущества" TEXT NOT NULL,
	"Дата_производства" DATE NOT NULL,
	CONSTRAINT "Имущество_pk" PRIMARY KEY ("ID_имущества")
) WITH (
  OIDS=FALSE
);



CREATE TABLE "Снаряжение" (
	"ID_снаряжения" integer NOT NULL,
	"Размер" TEXT NOT NULL,
	CONSTRAINT "Снаряжение_pk" PRIMARY KEY ("ID_снаряжения")
) WITH (
  OIDS=FALSE
);



CREATE TABLE "Оружие" (
	"ID_оружие" integer NOT NULL,
	"ID_комплекта_боеприпасов" integer NOT NULL,
	CONSTRAINT "Оружие_pk" PRIMARY KEY ("ID_оружие")
) WITH (
  OIDS=FALSE
);



CREATE TABLE "Техника" (
	"ID_комплекта_боеприпасов" integer NOT NULL,
	"ID_техники" integer NOT NULL,
	"Дальность_хода" integer NOT NULL,
	"Дефекты" TEXT NOT NULL,
	CONSTRAINT "Техника_pk" PRIMARY KEY ("ID_техники")
) WITH (
  OIDS=FALSE
);



CREATE TABLE "Место дислокации" (
	"ID_дежурного_подразделения" integer NOT NULL,
	"ID_места_дислокации" serial NOT NULL,
	"Название_места_дислокации" TEXT NOT NULL,
	"Адрес" TEXT NOT NULL,
	"Точное_расположение" TEXT NOT NULL
) WITH (
  OIDS=FALSE
);



CREATE TABLE "Боеприпасы" (
	"ID_комплекта_боеприпасов" integer NOT NULL,
	"Тип_боеприпасов" TEXT NOT NULL,
	"Количество" integer NOT NULL,
	CONSTRAINT "Боеприпасы_pk" PRIMARY KEY ("ID_комплекта_боеприпасов")
) WITH (
  OIDS=FALSE
);



CREATE TABLE "Сооружения" (
	"ID_сооружения" serial NOT NULL,
	"Название_сооружения" serial NOT NULL,
	"ID_места_дислокации" integer NOT NULL
) WITH (
  OIDS=FALSE
);



CREATE TABLE "Неисправности_техники" (
	"ID_техники" integer NOT NULL,
	"Описание_неисправности" TEXT NOT NULL,
	CONSTRAINT "Неисправности_техники_pk" PRIMARY KEY ("ID_техники")
) WITH (
  OIDS=FALSE
);



CREATE TABLE "Записи" (
	"ID_личного_дела" serial NOT NULL,
	"Тип_записи" TEXT NOT NULL,
	"Содержание" TEXT NOT NULL
) WITH (
  OIDS=FALSE
);



--ALTER TABLE "Подразделение" ADD CONSTRAINT "Подразделение_fk0" FOREIGN KEY ("ID_командира_подразделения") REFERENCES "Военнослужащий"("ID_Военнослужащего");
--ALTER TABLE "Подразделение" ADD CONSTRAINT "Подразделение_fk1" FOREIGN KEY ("ID_большего_подразделения") REFERENCES "Подразделение"("ID_подразделения");
--ALTER TABLE "Военнослужащий" ADD CONSTRAINT "Военнослужащий_fk0" FOREIGN KEY ("ID_подчинённого_подразделения") REFERENCES "Подразделение"("ID_подразделения");
--ALTER TABLE "Имущество" ADD CONSTRAINT "Имущество_fk0" FOREIGN KEY ("ID_подразделения") REFERENCES "Подразделение"("ID_подразделения");
--ALTER TABLE "Снаряжение" ADD CONSTRAINT "Снаряжение_fk0" FOREIGN KEY ("ID_снаряжения") REFERENCES "Имущество"("ID_имущества");
--ALTER TABLE "Оружие" ADD CONSTRAINT "Оружие_fk0" FOREIGN KEY ("ID_оружие") REFERENCES "Имущество"("ID_имущества");
--ALTER TABLE "Оружие" ADD CONSTRAINT "Оружие_fk1" FOREIGN KEY ("ID_комплекта_боеприпасов") REFERENCES "Боеприпасы"("ID_комплекта_боеприпасов");
--ALTER TABLE "Техника" ADD CONSTRAINT "Техника_fk0" FOREIGN KEY ("ID_комплекта_боеприпасов") REFERENCES "Боеприпасы"("ID_комплекта_боеприпасов");
--ALTER TABLE "Техника" ADD CONSTRAINT "Техника_fk1" FOREIGN KEY ("ID_техники") REFERENCES "Имущество"("ID_имущества");
--ALTER TABLE "Место дислокации" ADD CONSTRAINT "Место дислокации_fk0" FOREIGN KEY ("ID_дежурного_подразделения") REFERENCES "Подразделение"("ID_подразделения");
--ALTER TABLE "Место дислокации" ADD CONSTRAINT "Место дислокации_fk1" FOREIGN KEY ("ID_места_дислокации") REFERENCES "Подразделение"("ID_места_дислокации");
--ALTER TABLE "Боеприпасы" ADD CONSTRAINT "Боеприпасы_fk0" FOREIGN KEY ("ID_комплекта_боеприпасов") REFERENCES "Имущество"("ID_имущества");
--ALTER TABLE "Сооружения" ADD CONSTRAINT "Сооружения_fk0" FOREIGN KEY ("ID_места_дислокации") REFERENCES "Место дислокации"("ID_места_дислокации");
--ALTER TABLE "Неисправности_техники" ADD CONSTRAINT "Неисправности_техники_fk0" FOREIGN KEY ("ID_техники") REFERENCES "Техника"("ID_техники");
--ALTER TABLE "Записи" ADD CONSTRAINT "Записи_fk0" FOREIGN KEY ("ID_личного_дела") REFERENCES "Военнослужащий"("ID_Военнослужащего");



-- Личный состав -------------------------------------------------------------------------------------------------------

-- взвод-1
-- отделение-1
--select * from Военнослужащий
--insert into Военнослужащий ("ID_военнослужащего", "ID_подразделения", "ID_подчинённого_подразделения", "ФИО_военнослужащего", "Звание", "Состав", "Должность", "Специальность", "Выслуга_лет")
--values (1, 1, null, 'Пётр', 'рядовой', 'солдат', null, null, 1)
--values (2, 1, null, 'Леонид', 'рядовой', 'солдат', null, null, 1)
--values (3, 1, 1, 'Артемий', 'рядовой', 'солдат', 'командир отделения', 'Инженерные войска', 3)
--values (4, 1, null, 'Василий', 'рядовой', 'солдат', null, null, 2)
--values (5, 1, null, 'Остап', 'рядовой', 'солдат', null, null, 1)
--values (6, 1, null, 'Борис', 'рядовой', 'солдат', null, null, 1)
--values (7, 1, null, 'Максим', 'рядовой', 'солдат', null, null, 1)

-- отделение-2
--select * from Военнослужащий
--insert into Военнослужащий ("ID_военнослужащего", "ID_подразделения", "ID_подчинённого_подразделения", "ФИО_военнослужащего", "Звание", "Состав", "Должность", "Специальность", "Выслуга_лет")
--values (8, 2, null, 'Евгений', 'рядовой', 'солдат', null, null, 1)
--values (9, 2, null, 'Константин', 'рядовой', 'солдат', null, null, 1)
--values (10, 2, null, 'Савва', 'рядовой', 'солдат', null, null, 1)
--values (11, 2, null, 'Марк', 'рядовой', 'солдат', null, null, 2)
--values (12, 2, 2, 'Кирилл', 'рядовой', 'солдат', 'командир отделения', null, 2)
--values (13, 2, null, 'Григорий', 'рядовой', 'солдат', null, null, 1)
--values (14, 2, null, 'Денис', 'рядовой', 'солдат', null, null, 1)

-- отделение-3
--select * from Военнослужащий
--insert into Военнослужащий ("ID_военнослужащего", "ID_подразделения", "ID_подчинённого_подразделения", "ФИО_военнослужащего", "Звание", "Состав", "Должность", "Специальность", "Выслуга_лет")
--values (15, 3, null, 'Сергей', 'рядовой', 'солдат', null, null, 1)
--values (16, 3, null, 'Тарас', 'рядовой', 'солдат', null, null, 1)
--values (17, 4, 4, 'Кирилл', 'старшина', 'сержанты и старшины', 'командир взвода', 'инженерные войска', 4)
--values (18, 3, null, 'Давид', 'рядовой', 'солдат', null, null, 2)
--values (19, 3, 3, 'Макар', 'сержант', 'сержанты и старшины', 'командир отделения', null, 3)
--values (20, 3, null, 'Алексей', 'рядовой', 'солдат', null, null, 1)

-- взвод-2
-- отделение-1
--select * from Военнослужащий
--insert into Военнослужащий ("ID_военнослужащего", "ID_подразделения", "ID_подчинённого_подразделения", "ФИО_военнослужащего", "Звание", "Состав", "Должность", "Специальность", "Выслуга_лет")
--values (21, 5, null, 'Марк'      , 'рядовой', 'солдат'              , null                , null                   , 2)
--values (22, 5, null, 'Феликс'    , 'рядовой', 'солдат'              , null                , null                   , 2)
--values (23, 5, 5   , 'Александр' , 'сержант', 'сержанты и старшины' , 'командир отделения', 'мотострелковые войска', 3)
--values (24, 5, null, 'Егор'      , 'рядовой', 'солдат'              , null                , null                   , 2)
--values (25, 8, 8   , 'Константин', 'старшина', 'сержанты и старшины', 'командир взвода'   , 'мотострелковые войска', 4)
--values (26, 5, null, 'Григорий'  , 'рядовой', 'солдат'              , null                , null                   , 2)
--values (27, 5, null, 'Семен'     , 'рядовой', 'солдат'              , null                , null                   , 2)

-- отделение-2
--select * from Военнослужащий
--insert into Военнослужащий ("ID_военнослужащего", "ID_подразделения", "ID_подчинённого_подразделения", "ФИО_военнослужащего", "Звание", "Состав", "Должность", "Специальность", "Выслуга_лет")
--values (28, 6, null, 'Ян'     , 'рядовой' , 'солдат', null                , null, 1)
--values (29, 6, null, 'Василий', 'рядовой' , 'солдат', null                , null, 1)
--values (30, 6, null, 'Кирилл' , 'рядовой' , 'солдат', null                , null, 1)
--values (31, 6, null, 'Игнатий', 'рядовой' , 'солдат', null                , null, 1)
--values (32, 6, null, 'Фома'   , 'рядовой' , 'солдат', null                , null, 1)
--values (33, 6, null, 'Трофим' , 'рядовой' , 'солдат', null                , null, 1)
--values (34, 6, 6   , 'Илья'   , 'ефрейтор', 'солдат', 'командир отделения', null, 2)

-- отделение-3
--select * from Военнослужащий
--insert into Военнослужащий ("ID_военнослужащего", "ID_подразделения", "ID_подчинённого_подразделения", "ФИО_военнослужащего", "Звание", "Состав", "Должность", "Специальность", "Выслуга_лет")
--values (35, 7, null, 'Филипп'  , 'рядовой'  , 'солдат', null                , null, 1)
--values (36, 7, null, 'Кирилл'  , 'рядовой'  , 'солдат', null                , null, 1)
--values (37, 7, null, 'Степан'  , 'рядовой'  , 'солдат', null                , null, 1)
--values (38, 7, 7   , 'Глеб'    , 'ефрейтор' , 'солдат', 'командир отделения', null, 2)
--values (39, 7, null, 'Григорий', 'рядовой'  , 'солдат', null                , null, 1)
--values (40, 7, null, 'Терентий', 'рядовой'  , 'солдат', null                , null, 1)

-- взвод-3
-- отделение-1
--select * from Военнослужащий
--insert into Военнослужащий ("ID_военнослужащего", "ID_подразделения", "ID_подчинённого_подразделения", "ФИО_военнослужащего", "Звание", "Состав", "Должность", "Специальность", "Выслуга_лет")
--values (41, 10, null, 'Марк'      , 'рядовой', 'солдат'              , null                , null                   , 2)
--values (42, 10, null, 'Феликс'    , 'рядовой', 'солдат'              , null                , null                   , 2)
--values (43, 10, 10   , 'Александр' , 'сержант', 'сержанты и старшины' , 'командир отделения', 'мотострелковые войска', 3)
--values (44, 10, null, 'Егор'      , 'рядовой', 'солдат'              , null                , null                   , 2)
--values (45, 13, 13  , 'Константин', 'старшина', 'сержанты и старшины', 'командир взвода'   , 'мотострелковые войска', 4)
--values (46, 10, null, 'Григорий'  , 'рядовой', 'солдат'              , null                , null                   , 2)
--values (47, 10, null, 'Семен'     , 'рядовой', 'солдат'              , null                , null                   , 2)

-- отделение-2
--select * from Военнослужащий
--insert into Военнослужащий ("ID_военнослужащего", "ID_подразделения", "ID_подчинённого_подразделения", "ФИО_военнослужащего", "Звание", "Состав", "Должность", "Специальность", "Выслуга_лет")
--values (48, 11, null, 'Ян'     , 'рядовой' , 'солдат', null                , null, 1)
--values (49, 11, null, 'Василий', 'рядовой' , 'солдат', null                , null, 1)
--values (50, 11, null, 'Кирилл' , 'рядовой' , 'солдат', null                , null, 1)
--values (51, 11, null, 'Игнатий', 'рядовой' , 'солдат', null                , null, 1)
--values (52, 11, null, 'Фома'   , 'рядовой' , 'солдат', null                , null, 1)
--values (53, 11, null, 'Трофим' , 'рядовой' , 'солдат', null                , null, 1)
--values (54, 11, 11  , 'Илья'   , 'ефрейтор', 'солдат', 'командир отделения', null, 2)

-- отделение-3
--select * from Военнослужащий
--insert into Военнослужащий ("ID_военнослужащего", "ID_подразделения", "ID_подчинённого_подразделения", "ФИО_военнослужащего", "Звание", "Состав", "Должность", "Специальность", "Выслуга_лет")
--values (55, 12, null, 'Филипп'  , 'рядовой'  , 'солдат', null                , null, 1)
--values (56, 12, null, 'Кирилл'  , 'рядовой'  , 'солдат', null                , null, 1)
--values (57, 12, null, 'Степан'  , 'рядовой'  , 'солдат', null                , null, 1)
--values (58, 12, 12  , 'Глеб'    , 'ефрейтор' , 'солдат', 'командир отделения', null, 2)
--values (59, 12, null, 'Григорий', 'рядовой'  , 'солдат', null                , null, 1)
--values (60, 12, null, 'Терентий', 'рядовой'  , 'солдат', null                , null, 1)

-- командир роты
--values (61, 9, 9    , 'Христиан', 'лейтенант'  , 'младшие офицеры', 'командир роты', 'инженерные войска', 7)

-- Подразделения -------------------------------------------------------------------------------------------------------

--select * from Подразделение
--insert into Подразделение ("ID_командира_подразделения", "ID_подразделения", "Тип_подразделения", "ID_большего_подразделения", "Тип_большего_подразделения", "ID_места_дислокации", "Название_подразделения")
--values (3, 1, 'отделение', 4, 'взвод', 1, 'О-1')
--values (3, 2, 'отделение', 4, 'взвод', 1, 'О-2')
--values (3, 3, 'отделение', 4, 'взвод', 1, 'О-3')
--values (3, 4, 'взвод', -1, 'рота', 1, 'В-1')

--select * from Подразделение
--insert into Подразделение ("ID_командира_подразделения", "ID_подразделения", "Тип_подразделения", "ID_большего_подразделения", "Тип_большего_подразделения", "ID_места_дислокации", "Название_подразделения")
--values (23, 5, 'отделение', 8, 'взвод', 1, 'О-1')
--values (34, 6, 'отделение', 8, 'взвод', 1, 'О-2')
--values (38, 7, 'отделение', 8, 'взвод', 1, 'О-3')
--values (25, 8, 'взвод', 9, 'рота', 1, 'В-2')
--values (61, 9, 'рота', -1, 'батальон', 1, 'Р-1') -- тут рота

--select * from Подразделение
--insert into Подразделение ("ID_командира_подразделения", "ID_подразделения", "Тип_подразделения", "ID_большего_подразделения", "Тип_большего_подразделения", "ID_места_дислокации", "Название_подразделения")
--values (43, 10, 'отделение', 13, 'взвод', 1, 'О-1')
--values (54, 11, 'отделение', 13, 'взвод', 1, 'О-2')
--values (58, 12, 'отделение', 13, 'взвод', 1, 'О-3')
--values (45, 13, 'взвод', 9, 'рота', 1, 'В-3')

-- полезные запросы ----------------------------------------------------------------------------------------------------

--select * from Подразделение
--order by "ID_подразделения"

--select * from Военнослужащий
--order by "ID_военнослужащего"

--select * from Подразделение
--inner join Военнослужащий
--	on Военнослужащий."ID_подразделения" = Подразделение."ID_подразделения"
--where Подразделение."ID_подразделения" = 3

--select * from Военнослужащий where "ID_подразделения" = 2


-- функции -------------------------------------------------------------------------------------------------------------
1)
--create function get_private(integer) returns setof Военнослужащий as
--$$
--select * from Военнослужащий where "ID_военнослужащего" = $1;
--$$
--language sql;

--select * from get_private(1)

2)
--create function get_personnel(integer) returns setof Подразделение as
--$$
--select * from Подразделение where "ID_большего_подразделения" = $1;
--$$
--language sql;

--select * from get_personnel(9)

3)
--CREATE PROCEDURE set_register(integer, text, text)
--language plpgsql
--as
--$$ begin
--insert into Записи ("ID_личного_дела", "Тип_записи", "Содержание")
--values ($1, $2, $3);
--commit;
--end; $$;

--call set_register(71, 'приказ', 'текст приказа')

4)
--CREATE PROCEDURE set_soldier(integer, integer, integer, text, text, text, text, text, integer)
--language plpgsql
--as
--$$ begin
--insert into Военнослужащий ("ID_военнослужащего", "ID_подразделения", "ID_подчинённого_подразделения", "ФИО_военнослужащего", "Звание", "Состав", "Должность", "Специальность", "Выслуга_лет")
--values ($1, $2, $3, $4, $5, $6, $7, $8, $9);
--commit;
--end; $$;

--call set_soldier(-5,-5,-5,'тест','тест','тест','тест','тест',-5)

-- представление -------------------------------------------------------------------------------------------------------
1)
--create or replace view who_am_i as
--select Военнослужащий."ID_военнослужащего", Военнослужащий."Должность", Подразделение."Название_подразделения"
--from Военнослужащий, Подразделение
--where Военнослужащий."ID_подчинённого_подразделения" = Подразделение."ID_подразделения"

- select * from who_am_i

-- Роли ----------------------------------------------------------------------------------------------------------------

create role Военком;
grant insert on Военнослужащий to Военком;

create role Секретарь;
grant update, select on Военнослужащий to Секретарь;
grant update, select, insert on Записи to Секретарь;

create role Админ;
grant update, select, insert, delete on Военнослужащий to Админ;
grant update, select, insert, delete on Записи to Админ;
grant update, select, insert, delete on Подразделение to Админ;

create role сисадмин with login password 'hello_world';
grant update, select, insert, delete on Военнослужащий to сисадмин;

-- триггер -------------------------------------------------------------------------------------------------------------

--CREATE OR REPLACE FUNCTION insert_trigger_func() RETURNS trigger AS
--$$ BEGIN
--INSERT INTO Записи ("ID_личного_дела", "Тип_записи", "Содержание")
--VALUES(NEW."ID_военнослужащего", 'прибыл для несения службы', NEW."ФИО_военнослужащего");
--RETURN NEW;
--END;$$
--LANGUAGE 'plpgsql';

--create or replace trigger new_soldier
--after insert on Военнослужащий
--for each row
--execute procedure insert_trigger_func()

